# レフィー 授業レポート自動化システム — 機能要件定義書

## 1. システム概要

### 1.1 目的
個別指導塾「レフィー」において、講師が入力した授業レポートをAIが自動でまとめ、保護者に定期的にメール送信することで、保護者の安心感を高めつつ、塾長の面談準備工数を削減する。

### 1.2 全体フロー
```
講師が授業後にレポート入力（スマホ）
    ↓
  [または] 紙レポートをスマホ撮影 → AI-OCRでフォームにプリフィル → 講師が確認・送信
    ↓
レポートがDBに蓄積
    ↓
設定数（デフォルト4授業）たまったらAIがまとめを自動生成
    ↓
塾長が管理画面でチェック・編集 → 承認 → 保護者にメール送信
    ↓
  [または] 自動送信モード：生成後24時間塾長に通知 → 異議なければ自動送信
```

### 1.3 技術スタック（想定）
- フロントエンド：Next.js（スマホ最適化）
- バックエンド：Next.js API Routes
- DB：Supabase（PostgreSQL）
- 認証：Supabase Auth（メール+パスワード）
- AI まとめ生成：Claude API
- AI-OCR：Claude Vision API
- メール送信：Resend or SendGrid
- デプロイ：Vercel

---

## 2. ユーザーと権限

| ロール | できること |
|--------|-----------|
| 塾長（管理者） | 全機能。生徒・講師・保護者の管理、レポート閲覧、AIまとめの承認・編集・送信、各種設定 |
| 講師 | 授業レポートの入力（自分の担当生徒のみ）。自分が過去に入力したレポートの閲覧 |
| 保護者 | メール受信のみ（MVP）。※将来的にWeb上で過去レポート閲覧機能を追加可能 |

---

## 3. 画面・機能詳細

### 3.1 講師用：授業レポート入力画面（スマホ最適化）

#### 3.1.1 認証
- メールアドレス + パスワードによるログイン
- アカウントは塾長が管理画面から発行
- ログイン後、講師名は自動セット

#### 3.1.2 入力項目

| # | 項目 | 入力方式 | 必須/任意 | 備考 |
|---|------|---------|----------|------|
| 1 | 生徒名 | 担当生徒からプルダウン選択 | 必須 | ログイン講師の担当生徒のみ表示 |
| 2 | 日付 | 日付ピッカー（デフォルト当日） | 必須 | |
| 3 | 科目 | 選択式 | 必須 | 選択肢は塾長がマスタ管理で設定 |
| 4 | 使用テキスト | テキスト入力。複数エントリ追加可能（「＋追加」ボタン） | 必須（最低1つ） | 各エントリは「テキスト名 / ページ」形式。ページはカンマ区切りで飛ばしページ対応。例：「新中問 数学1 / p.12-15, p.20, p.33-35」 |
| 5 | 扱った単元 | 自由記述テキスト | 必須 | 例：「通分、異分母の足し算」 |
| 6 | 前回宿題のチェック | 3択選択 | 必須 | 「やってきた / 一部やった / やってきていない」 |
| 7 | 生徒の様子（ポジティブ） | 複数選択チップ | 最低1つ選択 | 選択肢（塾長がマスタ管理で編集可能）。デフォルト：集中できていた / 自分から質問した / 前回より改善が見られた / 意欲的だった / ノートを丁寧に書いていた |
| 8 | 生徒の様子（ネガティブ） | 複数選択チップ | 任意（0でもOK） | 選択肢（塾長がマスタ管理で編集可能）。デフォルト：集中が切れやすかった / 眠そうだった / 問題を解くのを嫌がった / 同じミスを繰り返した |
| 9 | 様子の自由コメント | 自由記述テキスト | 任意 | 例：「最初はだるそうだったが、後半の文章題で急にスイッチ入った」 |
| 10 | 宿題内容 | テキスト入力 | 必須 | 出した宿題の内容 |
| 11 | 次回やること | テキスト入力 | 任意 | 次回授業の冒頭でやること |
| 12 | 講師間申し送り | テキスト入力 | 任意 | 保護者には非公開。担当変更時などの引き継ぎ用 |

#### 3.1.3 OCR入力機能（紙レポート対応）

**フロー：**
1. レポート入力画面で「写真から入力」ボタンをタップ
2. スマホカメラで紙のレポートを撮影（またはカメラロールから選択）
3. 画像をClaude Vision APIに送信
4. AIが手書き内容を解釈し、各フォーム項目に自動マッピング・プリフィル
5. 講師がプリフィルされた内容を確認・修正
6. 送信

**要件：**
- 紙のレポート用紙は、Webフォームの入力項目と同じ構成に揃える（塾側で用紙を用意）
- AIは手書き文字の認識だけでなく、内容の意味を理解して適切な項目に振り分ける
- プリフィル後は通常のフォーム画面に遷移し、講師が自由に修正可能
- 読み取り精度が低い箇所はハイライト表示し、講師に確認を促す

#### 3.1.4 過去レポート閲覧
- 自分が入力した過去のレポートを生徒別・日付順で閲覧可能
- 前回の授業内容を確認してから今回のレポートを書ける

---

### 3.2 塾長用：管理画面

#### 3.2.1 ダッシュボード
- **未チェックAIまとめ件数**：バッジ表示。クリックで一覧へ遷移
- **直近のレポート入力状況**：講師別の入力件数。サボり検知用
- **レポート未入力アラート**：授業スケジュールが登録されている場合、授業があったのに入力がない講師・生徒をアラート表示（※授業スケジュール管理は3.2.5参照）

#### 3.2.2 AIまとめ確認・送信画面

**一覧画面：**
- 生徒名、科目、まとめ対象期間、ステータス（未チェック / 承認済み / 送信済み）で一覧表示
- フィルタ：ステータス別、生徒別、日付順

**詳細画面：**
- 左（上）：AIが生成したまとめ文（編集可能なテキストエリア）
- 右（下）：元の授業レポート一覧（まとめ対象の全件を展開表示）
- 操作ボタン：
  - 「承認して送信」→ 確認ダイアログ後、保護者にメール送信
  - 「再生成」→ AIに再度まとめを生成させる（プロンプト微調整のオプション付き）
  - 「保留」→ 送信せず保留状態に

#### 3.2.3 生徒管理
- 生徒一覧（CRUD）
- 各生徒の項目：
  - 氏名
  - 学年
  - 担当講師（複数可。科目ごとに異なる場合がある）
  - 保護者メールアドレス（複数可）
  - 通塾科目
  - まとめ頻度（N授業ごと。デフォルト4）
  - 送信モード（手動承認 / 自動送信）

#### 3.2.4 講師管理
- 講師一覧（CRUD）
- 各講師の項目：
  - 氏名
  - メールアドレス（ログイン用）
  - 担当生徒（紐づけ）
- アカウント発行：塾長が登録 → 講師にメールで初期パスワード通知（または招待リンク）

#### 3.2.5 授業スケジュール管理（オプション）
- 生徒ごとの曜日・時間帯を登録可能
- レポート未入力検知に使用
- MVPでは簡易的に「週あたりのコマ数」のみ登録でもOK

#### 3.2.6 マスタ管理
- **科目マスタ**：科目の追加・編集・削除
- **生徒の様子カテゴリ**：ポジティブ/ネガティブ選択肢の追加・編集・削除
- **テキストマスタ**（任意）：よく使うテキスト名をマスタ登録しておき、講師入力時にサジェスト表示

#### 3.2.7 設定
- 塾名表示設定
- メール送信元アドレス設定
- メール署名テンプレート
- AIまとめのデフォルト頻度（全生徒共通のデフォルト値）
- 自動送信モード時の待機時間（デフォルト24時間）

---

### 3.3 AIまとめ生成機能

#### 3.3.1 トリガー
- ある生徒の授業レポートが、設定されたまとめ頻度（デフォルト4授業）に達したとき自動的に生成
- 塾長が管理画面から手動で「今あるレポートでまとめを生成」も可能

#### 3.3.2 入力
- まとめ対象の授業レポート群（全項目）
- 生徒の基本情報（学年、科目）

#### 3.3.3 出力構成

```
【学習進捗】
対象期間にどのテキストのどの範囲を扱い、どんな単元を学習したか。

【理解度・課題】
各単元の理解状況、つまずきポイント、前回からの変化。

【授業中の様子】
態度・姿勢面の特徴、ポジティブな変化、課題。

【今後の方針・ご家庭へのお願い】
次に取り組む内容、宿題の状況を踏まえた家庭への依頼。
```

#### 3.3.4 文体ルール
- シンプル・端的な敬語。冗長な表現を避ける
- 事実ベースで書く。根拠のない評価をしない
- ネガティブな内容は建設的に表現する（例：「できなかった」→「課題として残っています」）
- 保護者が読んで「ちゃんと見てもらっている」と感じる具体性を担保する

#### 3.3.5 AIプロンプト設計方針
- 授業レポートの生データを全て渡し、上記構成・文体ルールに従ってまとめさせる
- 講師間申し送り（非公開項目）はまとめに含めない
- 講師の自由記述が雑でも、選択式項目のデータから補完してまとめを生成できる設計とする

---

### 3.4 メール送信機能

#### 3.4.1 送信内容
- **送信元**：塾のメールアドレス（設定画面で指定）
- **送信先**：生徒に紐づく保護者メールアドレス（複数対応）
- **件名**：「【レフィー】〇〇さんの学習レポート（〇月）」
- **本文**：AIまとめ文 + 塾の署名（設定画面で指定したテンプレート）
- **形式**：テキストメール（HTMLメールはMVPでは不要）

#### 3.4.2 送信モード

**手動承認モード（デフォルト）：**
- AIまとめ生成 → 塾長が確認・編集 → 「承認して送信」で送信

**自動送信モード：**
- AIまとめ生成 → 塾長に通知メール（まとめ内容のプレビュー付き）
- 設定時間（デフォルト24時間）経過後、塾長が差し戻していなければ自動送信
- 塾長は通知メール内のリンクから管理画面に遷移し、差し戻し・編集可能

#### 3.4.3 送信履歴
- 送信済みレポートの一覧を管理画面で閲覧可能
- 生徒別、日付別で検索可能

---

## 4. 非機能要件

### 4.1 対応デバイス
- 講師用画面：スマートフォン最適化（iOS Safari, Android Chrome）
- 塾長管理画面：PC最適化（スマホからも最低限操作可能）

### 4.2 セキュリティ
- 全通信HTTPS
- 認証はSupabase Auth（JWT）
- 講師は自分の担当生徒のデータのみアクセス可能（RLS）
- 保護者のメールアドレスは講師には非表示

### 4.3 パフォーマンス
- レポート入力画面のロード：2秒以内
- OCR解析：10秒以内（ローディング表示）
- AIまとめ生成：30秒以内（バックグラウンド処理、完了通知）

---

## 5. MVP範囲と将来拡張

### 5.1 MVP（初期リリース）
- 講師用レポート入力画面（OCR含む）
- 塾長用管理画面（ダッシュボード、まとめ確認・送信、生徒・講師管理）
- AIまとめ生成（4授業ごと、手動承認モード）
- メール送信（テキストメール）

### 5.2 将来拡張候補
- 保護者向けWebポータル（過去レポート閲覧）
- LINE送信対応
- HTMLメール（デザイン付き）
- 面談準備機能（過去のまとめを時系列で一覧表示し、面談用資料を自動生成）
- 生徒の成績推移グラフ（テスト結果入力機能と連動）
- 授業スケジュール管理の本格化（カレンダー連携）

---

## 6. AIまとめ出力サンプル

以下は4授業分のレポートからAIが生成するまとめのイメージ。

---

> **【学習進捗】**
> 10/5〜10/26の4回の授業で、「新中問 数学1」p.45-62を中心に、一次方程式の文章題から連立方程式の導入まで進みました。
>
> **【理解度・課題】**
> 一次方程式の計算は正確にできるようになりました。文章題では「何をxとおくか」の判断にまだ時間がかかる場面がありますが、回を重ねるごとに改善しています。連立方程式は加減法の基本に入ったところで、次回以降定着を図ります。
>
> **【授業中の様子】**
> 集中して取り組めており、10月後半からは自分から質問する場面が増えました。宿題は毎回きちんとやってきています。
>
> **【今後の方針・ご家庭へのお願い】**
> 次の期間は連立方程式の計算演習を中心に進めます。一次方程式の文章題は宿題で継続しますので、ご家庭でも声かけいただけると定着が早まります。

---
